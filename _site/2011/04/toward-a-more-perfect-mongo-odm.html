<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Finagle</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link href="/stylesheets/master.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/color.css" media="screen" rel="stylesheet" type="text/css" />

  <script src="/javascripts/prototype.js" type="text/javascript"></script>
  <script src="/javascripts/effects.js" type="text/javascript"></script>
  <script src="/javascripts/typo.js" type="text/javascript"></script>
  <script src="/javascripts/lucid.js" type="text/javascript"></script>

  <link href="/feed/atom.xml" rel="alternate" type="application/atom+xml" />
</head>
<body class="c-ms cs0 fixed">
  <div id="wrapper">
    <div id="w2">
      <div class="clearfix" id="w3">
        <div class="clearfix" id="header">
          <div id="logo">
            <!-- <a href="/"><img src="/images/logo.png" alt="" /></a> -->
            <h1 class="pageTitle">
              <a href="/">Finagle</a>
              <!-- <span class='subtitle'>&mdash; a weblog</span> -->
            </h1>
            <h2>Changing the world would be easier if I had the source code.</h2>
          </div>
          <div id="search"></div>
        </div>
        <div id="content">
  <div id="maincol">
    <div id="mc2">

      <div class="post">
        <div class="post-title"><h1>Toward a More Perfect Mongo ODM</h1></div>
        <p class="auth">Posted by code_monkey_steve,
          <span class="typo_date" title="2011/04/24">2011-04-24 00:00:00 -0700</span></p>
        <div class="post-body">
        <h2>MongoDB, MongoMapper, and Mongoid</h2>
<p>I&#8217;m now well into my third Rails project using the <a href="http://mongodb.org">MongoDB</a> document database, and while I&#8217;m still a big fan of<br />
Mongo, I&#8217;ve been underwhelmed by the <acronym title="Object-Document Mapper"><span class="caps">ODM</span></acronym>s I&#8217;ve used.  On the first project, I started with <a href="http://mongomapper.com">MongoMapper</a>, which is very mature and well-supported, but was a little klunky and tried a little too hard to be like <a href="http://ar.rubyonrails.org">ActiveRecord</a>.</p>
<p>For the second project, I switched to <a href="http://mongoid.org">Mongoid</a>, which was a huge improvement.  It played nicely with ActiveSupport and ActiveModel, and had better support for doing things the Mongo way.  But in the end, it had several nasty bugs related to associations and embedded documents, and the better I understood what I wanted from an <span class="caps">ODM</span>, the more I realized that Mongoid wasn&#8217;t it.</p>
<h2>The Alternatives</h2>
<h5><a href="https://github.com/SFEley/candy">Candy</a></h5>
<p>I looked into Candy, and found its approach intriguingly fresh.  Models don&#8217;t have to specify field names or types, and can be Arrays or Hashes or any other Ruby type.  But I don&#8217;t like the lack of control over the serialization process (e.g. <code>find</code>, <code>save</code>, callbacks, validations, etc.), nor the absence of any sort of relational mechanism.  Like Mongoid, it does have a nice query Criteria <span class="caps">DSL</span>, though.</p>
<h5><a href="http://mongomatic.com">Mongomatic</a></h5>
<p>I&#8217;m not sure Mongomatic even qualifies as an <span class="caps">ODM</span>, as it doesn&#8217;t seem to do any mapping.  From what I&#8217;ve seen, it&#8217;s just a thin wrapper around the Ruby MongoDB driver, adding little.  I don&#8217;t know why anyone would bother using it.</p>
<h5><a href="https://github.com/carlosparamio/mongo_odm">MongoODM</a> (<a href="https://github.com/CodeMonkeySteve/mongo_odm/">my fork</a>)</h5>
<p>It could use a better name, but it&#8217;s a nice <span class="caps">ODM</span>, if a bit immature.  I especially like its support for embedded documents, i.e. you don&#8217;t have to do anything special, just assign a variable of the specified Mongo-serializeable type (Document or otherwise) to a field, and it Just Works.  It also supports Arrays and Hashes that can take any heterogeneous collection of types.</p>
<p>It&#8217;s also better designed under the hood than Mongoid or MongoMapper, taking full advantage of Ruby conventions to be easily hackable.  Definitely the best closest candidate to my Perfect <span class="caps">ODM</span>.  MongoODM is definitely the best candidate for Perfect <span class="caps">ODM</span> I&#8217;ve yet seen.</p>
<h2>The Perfect <span class="caps">ODM</span></h2>
<p>Here&#8217;s what I really in my perfect Mongo <span class="caps">ODM</span>:</p>
<h5>Plays Well with Rails</h5>
<p>Like it or not, the ActiveRecord <span class="caps">API</span> is the standard convention for performing DB operations.  And to the extent that <span class="caps">SQL</span> and MongoDB are conceptually similar, they should maintain the same <span class="caps">API</span>.  This makes it easier to integrate with other software that may assume AR conventions, but more importantly, it keeps me from having to learn and remember a whole new set of only-slightly-different APIs.</p>
<h5><a href="http://en.wikipedia.org/wiki/Duck_typing">Duck typing</a> and Other Ruby-isms</h5>
<p>This is one big feature that ActiveRecord does not (and cannot) have, but which Mongo gives us almost for free &#8212; dynamic typing, just like native Ruby.  Mongoid supports this for polymorphism, and MongoODM also supports dynamic types in Hashes and Arrays, and it was this fact that original attracted me to it.  I have no problem with declaring document fields, but why should I have to specify the type?  For that matter, why should I be constrained to a static type?</p>
<h5>Schema <span class="caps">DSL</span></h5>
<p>Even though I want the freedom to store any value of any type in any field, I know that schemas are still important, both for validation and configuration management.  All ODMs provide ActiveRecord-style type-specifiers and validations (Mongoid and MongoODM also use ActiveModel), but I&#8217;d like to see document schemata become a top-level object, some superset of <a href="http://json-schema.org"><span class="caps">JSON</span> Schema</a>, with an friendly and extensible <span class="caps">DSL</span>.  Something like this:</p>
<blockquote><pre><code>class Person
    schema do
      property(:name) {
        type   String
        length 1..20
        required
      }
      property(:phone) {
        type Phone
        optional
      }
      property(:aliases) {
        type Array.of(String)
        optional
      }
      property(:vehicles) {
        type Array.of(Car, Boat, Spaceship)
        required
        default []
      }
      additional_properties false
    end
  end
</code></pre></blockquote>
<p>Once the schema is nestled into object form, there&#8217;s a whole bunch of interesting things you can do, in addition to validations:</p>
<ul>
	<li>Schema versioning and heterogeneous collections</li>
	<li>Data migrations and schema management</li>
	<li>Client-side validations (via <span class="caps">JSON</span> Schema)</li>
	<li>Automatic form generation (think: <a href="http://activescaffold.com">ActiveScaffold</a> on steroids)</li>
</ul>
<h5>References and Associations</h5>
<p>This area gets a bit tricky, partially because of SQL&#8217;s wretched legacy of foriegn keys and join tables, but also because the problem is just inherently difficult. Ideally, the database or <span class="caps">ODM</span> would provide an equivalent to Ruby&#8217;s garbage-collected memory management system, where any document field could be a reference to any other object of any type, and all objects would be automatically destroyed when no longer used.</p>
<p>MongoDB actually comes pretty close with their support for <a href="http://www.mongodb.org/display/DOCS/Database+References">Database References</a>.  These allow you to assign to a document field a reference to any document in any collection.  I&#8217;ve expanded MongoODM with a transparent Reference proxy, and assigning a reference to a field is as simple as calling <code>.reference</code> (or <code>.ref</code>) on a document.  I&#8217;ve been looking at adding something similar for <a href="http://www.mongodb.org/display/DOCS/GridFS+Specification">GridFS attachments</a>, but with a reference count to allow easy sharing of large binary objects between documents.</p>
<h2>The Future &#8212; No <span class="caps">ODM</span>?</h2>
<p>This post is mostly just a dump of ideas I&#8217;ve had while working to expand MongoODM.  But I find myself working more and more in Javascript, these days, and taking advantage of things like <a href="http://jquery.com">jQuery</a> and <a href="http://documentcloud.github.com/backbone">Backbone</a> to build rich client applications in the browser.  In this situation, which I think will become more common, I don&#8217;t need so much <span class="caps">ODM</span> support in Ruby/Rails, and more-so in Javascript.  So now I&#8217;m contemplating a MongoDB interface in JavaScript, passing through some sort of <a href="http://rack.rubyforge.org">Rack</a> proxy to perform access control.  I&#8217;ll let you know how it turns out &#8230;</p>
        </div>
        
          <p class="meta">
            Tags: mongodb
          </p>
        
        <div id="disqus_thread"></div>
      </div>

    </div>
  </div>
  <div id="subcol">
    <div class="bt"><div></div></div>
    <div id="sc2">
      <div class="sidebar-node">
  <h3>Related</h3>
    <ul class="counts">
      
        
      
        
          <li><a href="/2009/07/i-hate-shoulda-but-i-blame-test-unit.html">I Hate Shoulda (But I Blame Test::Unit)</a></li>
        
      
        
          <li><a href="/2011/03/back-from-the-dead.html">Back from the Dead</a></li>
        
      
        
          <li><a href="/2006/07/a-few-of-my-favorite-things.html">A Few of My Favorite Things</a></li>
        
      
        
          <li><a href="/2006/09/linking-outside-of-the-box-optimizing-ruby-with-c-c.html">Linking Outside of the Box: Optimizing Ruby with C/C++</a></li>
        
      
        
          <li><a href="/2010/10/take-my-money-please.html">Take my money, please!</a></li>
        
      
        
          <li><a href="/2006/09/odin.html">ODIN: Secure P2P on the Web</a></li>
        
      
        
          <li><a href="/2010/01/json-and-the-args-or-not.html">JSON and the Args (or Not)</a></li>
        
      
        
          <li><a href="/2007/03/back-on-rails.html">Back on Rails</a></li>
        
      
        
          <li><a href="/2009/05/couch-trouble.html">Couch Trouble</a></li>
        
      
        
          <li><a href="/2010/02/swing-from-tree-to-tree.html">Swinging from Tree to Tree</a></li>
        
      
    </ul>
</div>

    </div>
  </div>
</div>

<script type="text/javascript">
  var disqus_shortname = 'finagle';
  var disqus_identifier = '';
  var disqus_url = 'http://finagle.org/2011/04/toward-a-more-perfect-mongo-odm.html';

  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        <div id="footer">
          <p>
            <a href="http://validator.w3.org/check/referer" title="Validates this page">XHTML</a>,
            <a href="http://jigsaw.w3.org/css-validator/check/referer?warning=no&amp;profile=css2" title="Validates the CSS on this page.">CSS</a>.
            Template by <a href="http://www.soniciq.com" title="SonicIQ - Website Development">SonicIQ</a>.
            Blog comments powered by <a href="http://disqus.com" class="dsq-brlink">Disqus</a>.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-22936286-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
