<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Finagle</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link href="/stylesheets/master.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/color.css" media="screen" rel="stylesheet" type="text/css" />

  <script src="/javascripts/prototype.js" type="text/javascript"></script>
  <script src="/javascripts/effects.js" type="text/javascript"></script>
  <script src="/javascripts/typo.js" type="text/javascript"></script>
  <script src="/javascripts/lucid.js" type="text/javascript"></script>

  <link href="/feed/atom.xml" rel="alternate" type="application/atom+xml" />
</head>
<body class="c-ms cs0 fixed">
  <div id="wrapper">
    <div id="w2">
      <div class="clearfix" id="w3">
        <div class="clearfix" id="header">
          <div id="logo">
            <!-- <a href="/"><img src="/images/logo.png" alt="" /></a> -->
            <h1 class="pageTitle">
              <a href="/">Finagle</a>
              <!-- <span class='subtitle'>&mdash; a weblog</span> -->
            </h1>
            <h2>Changing the world would be easier if I had the source code.</h2>
          </div>
          <div id="search"></div>
        </div>
        <div id="content">
  <div id="maincol">
    <div id="mc2">

      <div class="post">
        <div class="post-title"><h1>Linking Outside of the Box: Optimizing Ruby with C/C++</h1></div>
        <p class="auth">Posted by code_monkey_steve,
          <span class="typo_date" title="2006/09/28">2006-09-28 00:00:00 -0700</span></p>
        <div class="post-body">
        <h3>Prototyping</h3>
<p>My first attempt at a routine to <span class="caps">XOR</span> blocks (stored as Strings) looked something like this:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">String</span>
  <span class="k">def</span> <span class="nf">xor!</span><span class="p">(</span> <span class="n">str1</span><span class="p">,</span> <span class="n">str2</span> <span class="p">)</span>
    <span class="no">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">128</span><span class="o">.</span><span class="n">kilobytes</span>
    <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">BLOCK_SIZE</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">self</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">^=</span> <span class="n">str1</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">^</span> <span class="n">str2</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div><p>There may very well be a faster way of doing this in pure Ruby, but I couldn&#8217;t find it (and didn&#8217;t want to waste the time).  This worked well enough to finish the basic implementation and unit tests.  And even though this prototype version was way too slow, it allowed me to build-out the higher-level code and tests so that went I went to replace it with the faster version, I had already established extensive code coverage (which revealed several bugs in my optimized implementation).  Once the prototype is complete it&#8217;s time for &#8230;</p>
<h3>Profiling</h3>
<blockquote>
<p>Premature optimization is the root of all evil.<br/>
- Donald Knuth</p>
</blockquote>
<p>Even though I knew that <span class="caps">XOR</span> was going to be the biggest cycle-sink, I decided that now would be a good time to learn about Ruby profiling.  <a href="http://ruby-prof.rubyforge.org/">ruby-prof</a> makes this fairly easy.  I chose my biggest, most involved unit test, and wrapped it like so:</p>
<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;ruby-prof&#39;</span>
<span class="k">def</span> <span class="nf">profile_lotsofstuff</span>
  <span class="n">res</span> <span class="o">=</span> <span class="no">RubyProf</span><span class="o">.</span><span class="n">profile</span> <span class="k">do</span>
    <span class="n">test_lotsofstuff</span>
  <span class="k">end</span>
  <span class="no">RubyProf</span><span class="o">::</span><span class="no">GraphPrinter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">alias_method</span> <span class="ss">:test_profile_lotsofstuff</span><span class="p">,</span> <span class="ss">:profile_lotsofstuff</span>   <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PROFILE&#39;</span><span class="o">]</span>
</code></pre>
</div><p>This allows me to easily profile by running that unit test from the command line:</p>
<div class="highlight"><pre><code class="sh">clear ; <span class="nv">PROFILE</span><span class="o">=</span>1 ruby <span class="nb">test</span>/unit/stuff_test.rb
</code></pre>
</div><p>While I&#8217;m still working on tweaking the various output parameters, the result did confirm my suspicions:</p>
<pre>
  %total   %self     total      self    children             calls   Name
--------------------------------------------------------------------------------
                      8.04      4.97      3.07                 4/4     String#xor!
  96.87%  59.88%      8.04      4.97      3.07                   4     Range#each
                      1.07      1.07      0.00     1048576/1048576     Fixnum#^
                      1.53      1.53      0.00     1572864/1572880     String#[]
                      0.47      0.47      0.00       524288/524288     String#[]=

</pre>
<h3>Extending with C</h3>
<p>Especially for tight nested loops like this, you quickly take a bit performance hit just from the loop overhead.  In this case, I also couldn&#8217;t find an easy way to iterate through two strings simultaneously.  After a while, it became quite annoying knowing that I could do the whole thing in a short little C function.</p>
<p>So that&#8217;s what I did.  I created a small Rails plugin (<code>xor</code>), with appropriate <code>init.rb</code>, and added a <code>lib/xor.c</code> that looks something like:</p>
<div class="highlight"><pre><code class="c">  <span class="n">VALUE</span> <span class="nf">string_xor</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">VALUE</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">self</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src1</span> <span class="o">=</span> <span class="n">STR2CSTR</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src2</span> <span class="o">=</span> <span class="n">STR2CSTR</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">STR2CSTR</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">RSTRING</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">;</span> <span class="o">++</span><span class="n">dest</span><span class="p">,</span> <span class="o">++</span><span class="n">src1</span><span class="p">,</span> <span class="o">++</span><span class="n">src2</span> <span class="p">)</span>
    <span class="o">*</span><span class="n">dest</span> <span class="o">^=</span> <span class="o">*</span><span class="n">src</span> <span class="o">^</span> <span class="o">*</span><span class="n">src2</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Init_xor</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">rb_define_method</span><span class="p">(</span> <span class="n">rb_cString</span><span class="p">,</span> <span class="s">&quot;xor!&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">VALUE</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">ANYARGS</span><span class="p">))</span> <span class="n">string_xor</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div><p>Using the <a href="onebananaproblem.com/articles/2006/09/09/ruby-extensions-with-rake">Rake task for Ruby extensions</a>  from my <a href="http:rubyforge.org/projects/rdbxml"><span class="caps">RDBXML</span></a> project makes it trivial to build with a small Rakefile:</p>
<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;rake/extensiontask&#39;</span>
<span class="n">desc</span> <span class="s2">&quot;Build the XOR extension&quot;</span>
<span class="no">Rake</span><span class="o">::</span><span class="no">ExtensionTask</span><span class="o">.</span><span class="n">new</span> <span class="ss">:xor</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;lib&#39;</span>
<span class="k">end</span>
</code></pre>
</div><p>Added some test cases for the various <span class="caps">XOR</span> identities (e.g. <code>x^0 = x</code>, <code>x^x = 0</code>, etc.) and that was it.  I kept the pure Ruby version of the function for later (renamed to <code>slow_xor!</code>).</p>
<h3>Benchmarking</h3>
<p>A few runs through the higher-level tests show a <strong>huge</strong> improvement in speed.  But just how much is that?  It&#8217;s easy to tell with Ruby&#8217;s built-in benchmarking support.  As with the profiling, I find it convenient to hack it onto the existing unit tests, as they already prove a good source of stress-tests.</p>
<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">benchmark_xor</span>
  <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">bm</span><span class="o">|</span>
      <span class="n">bm</span><span class="o">.</span><span class="n">report</span><span class="p">(</span> <span class="s2">&quot;XOR (c) :&quot;</span> <span class="p">)</span> <span class="p">{</span>  <span class="n">n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">test_xor</span> <span class="p">}</span>  <span class="p">}</span>
      <span class="nb">String</span><span class="o">.</span><span class="n">module_eval</span> <span class="p">{</span> <span class="n">alias_method</span> <span class="ss">:xor!</span><span class="p">,</span> <span class="ss">:slow_xor!</span> <span class="p">}</span>
      <span class="n">bm</span><span class="o">.</span><span class="n">report</span><span class="p">(</span> <span class="s2">&quot;XOR (rb):&quot;</span> <span class="p">)</span> <span class="p">{</span>  <span class="n">n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">test_xor</span> <span class="p">}</span>  <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">alias_method</span> <span class="ss">:test_benchmark_xor</span><span class="p">,</span> <span class="ss">:benchmark_xor</span>  <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;BENCHMARK&#39;</span><span class="o">]</span>
</code></pre>
</div><pre>              user     system      total        real
XOR (c) :  1.200000   0.116667   1.316667 (  0.817143)
XOR (rb): 81.433333   0.683333  82.116667 ( 50.567826)
</pre>
<p>This shows a speed-up of a little over 60&#215;.    This changes the execution times for just about every operation from &#8220;minutes&#8221; into &#8220;seconds&#8221;.  Not bad, eh?</p>
<blockquote>
<p>Your Milleage May Vary</p>
</blockquote>
        </div>
        
          <p class="meta">
            Tags: ruby extension
          </p>
        
        <div id="disqus_thread"></div>
      </div>

    </div>
  </div>
  <div id="subcol">
    <div class="bt"><div></div></div>
    <div id="sc2">
      <div class="sidebar-node">
  <h3>Related</h3>
    <ul class="counts">
      
        
      
        
          <li><a href="/2009/07/i-hate-shoulda-but-i-blame-test-unit.html">I Hate Shoulda (But I Blame Test::Unit)</a></li>
        
      
        
          <li><a href="/2006/07/a-few-of-my-favorite-things.html">A Few of My Favorite Things</a></li>
        
      
        
          <li><a href="/2010/10/take-my-money-please.html">Take my money, please!</a></li>
        
      
        
          <li><a href="/2006/09/odin.html">ODIN: Secure P2P on the Web</a></li>
        
      
        
          <li><a href="/2007/03/back-on-rails.html">Back on Rails</a></li>
        
      
        
          <li><a href="/2010/05/ruby-gets-possessive.html">Ruby Gets Possessive</a></li>
        
      
        
          <li><a href="/2010/02/swing-from-tree-to-tree.html">Swinging from Tree to Tree</a></li>
        
      
        
          <li><a href="/2009/04/seattle-rb-and-goruco-wisdom.html">Seattle.rb and GoRuCo Wisdom</a></li>
        
      
        
          <li><a href="/2009/11/long-time-no-blog.html">Long Time, No Blog</a></li>
        
      
        
          <li><a href="/2009/09/safe-mailing-with-safe_mail.html">Safe Mailing with mail_safe</a></li>
        
      
    </ul>
</div>

    </div>
  </div>
</div>

<script type="text/javascript">
  var disqus_shortname = 'finagle';
  var disqus_identifier = '';
  var disqus_url = 'http://finagle.org/2006/09/linking-outside-of-the-box-optimizing-ruby-with-c-c.html';

  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        <div id="footer">
          <p>
            <a href="http://validator.w3.org/check/referer" title="Validates this page">XHTML</a>,
            <a href="http://jigsaw.w3.org/css-validator/check/referer?warning=no&amp;profile=css2" title="Validates the CSS on this page.">CSS</a>.
            Template by <a href="http://www.soniciq.com" title="SonicIQ - Website Development">SonicIQ</a>.
            Blog comments powered by <a href="http://disqus.com" class="dsq-brlink">Disqus</a>.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Analytics -->
<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-10834046-1");
    pageTracker._trackPageview();
  } catch(err) {}
</script>

</body>
</html>
